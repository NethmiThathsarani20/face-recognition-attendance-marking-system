<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition Attendance System</title>
    
    <!-- Preconnect to CDN for faster resource loading -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    
    <!-- Inline critical CSS for faster rendering -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #6366f1;
            min-height: 100vh;
            line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }
        h1 { 
            text-align: center; 
            color: white; 
            margin-bottom: 40px; 
            font-size: 3rem; 
            font-weight: 700;
        }
    </style>
    
    <!-- Load main stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <!-- Load Font Awesome asynchronously -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></noscript>
</head>
<body>
    <div class="container">
        <h1>Face Recognition Attendance System</h1>
        
        <!-- Navigation -->
        <nav>
            <a href="{{ url_for('index') }}"><i class="fas fa-home"></i> Home</a>
            <a href="{{ url_for('add_user') }}"><i class="fas fa-user-plus"></i> Add User</a>
        </nav>
        
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card" id="registered_users_card" style="cursor: pointer;">
                <h3><i class="fas fa-users"></i> <span id="users_count">...</span></h3>
                <p>Registered Users</p>
            </div>
            <div class="stat-card" style="border-top-color: var(--secondary-color);">
                <h3 style="color: var(--secondary-color);"><i class="fas fa-check-circle"></i> <span id="attendance_count">...</span></h3>
                <p>Today's Attendance</p>
            </div>
        </div>
        
        <!-- Registered Users Modal -->
        <div id="users_modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-users"></i> Registered Users</h2>
                    <span class="close" id="close_modal_btn">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="users_list">
                        <p style="text-align: center; color: #6B7280;"><i class="fas fa-spinner fa-spin"></i> Loading users...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loading_indicator" class="loading-section" style="display: block;">
            <div class="loading-content">
                <div class="spinner"></div>
                <h3>üîÑ Initializing Face Recognition System...</h3>
                <p><strong>First time setup:</strong> Typically 2-3 minutes to download models and process user data.</p>
                <p style="font-size: 0.9em; margin-top: 10px; opacity: 0.8;">‚ú® Subsequent loads are instant (< 1 second) using cached data!</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress_fill"></div>
                </div>
            </div>
        </div>
        
        <!-- System Info -->
        <div class="info-section">
            <h3><i class="fas fa-microchip"></i> System Information</h3>
            <div style="padding: 15px; background: rgba(255,255,255,0.15); border-radius: 12px; backdrop-filter: blur(10px);">
                <p style="margin: 10px 0;"><i class="fas fa-robot"></i> <strong>Recognition Model:</strong> Embedding Classifier (LogisticRegression + InsightFace)</p>
                <p style="margin: 10px 0;"><i class="fas fa-tachometer-alt"></i> <strong>Optimized for:</strong> Raspberry Pi Performance</p>
                <p style="margin: 10px 0;"><i class="fas fa-check-circle"></i> <strong>Status:</strong> Ready for Fast Recognition</p>
            </div>
        </div>
        
        <!-- Attendance Marking -->
        <div class="attendance-section">
            <h2><i class="fas fa-camera"></i> Mark Attendance</h2>
            
            <!-- Camera Option -->
            <div class="input-method">
                <h3><i class="fas fa-video"></i> Camera Capture</h3>
                <div style="margin-bottom: 15px;">
                    <label>
                        <input type="radio" name="camera_type" value="local" checked onchange="toggleCameraInput()">
                        <i class="fas fa-desktop"></i> Local Camera (Index):
                    </label>
                    <input type="number" id="camera_index" value="0" min="0" max="10" style="margin-left: 10px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label>
                        <input type="radio" name="camera_type" value="ip" onchange="toggleCameraInput()">
                        <i class="fas fa-wifi"></i> IP Camera (URL):
                    </label>
                    <input type="text" id="camera_url" placeholder="e.g., http://user:pass@192.168.1.100:8080/video" 
                           style="margin-left: 10px; width: 100%; max-width: 500px;" disabled>
                </div>
                <div style="margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.7); border-radius: 8px; font-size: 13px; color: #374151;">
                    <strong><i class="fas fa-info-circle"></i> Common IP Camera URLs:</strong><br>
                    ‚Ä¢ Android IP Webcam: http://192.168.1.100:8080/video<br>
                    ‚Ä¢ ESP32-CAM: http://192.168.1.100:81/stream<br>
                    ‚Ä¢ With authentication: http://username:password@192.168.1.100:8080/video<br>
                    ‚Ä¢ RTSP: rtsp://192.168.1.100:554/stream
                </div>
                <button onclick="testCamera()"><i class="fas fa-vial"></i> Test Camera</button>
                <button onclick="markAttendanceCamera()" class="btn-success"><i class="fas fa-camera"></i> Mark Attendance</button>
                
                <div class="auto-mode-controls">
                    <label>
                        <input type="checkbox" id="auto_mode_enabled" onchange="toggleAutoMode()">
                        <i class="fas fa-sync-alt"></i> Enable Automatic Recognition Mode
                    </label>
                    <div id="auto_mode_status" style="display: none;">
                        Auto Recognition: <span id="auto_status">Inactive</span>
                    </div>
                </div>
                <div id="camera_result"></div>
            </div>
            
            <!-- Upload Option -->
            <div class="input-method">
                <h3><i class="fas fa-upload"></i> Image Upload</h3>
                <input type="file" id="image_upload" accept="image/*">
                <button onclick="markAttendanceUpload()" class="btn-success"><i class="fas fa-check-circle"></i> Mark Attendance</button>
                <div id="upload_result"></div>
            </div>
        </div>
        
        <!-- Results Display -->
        <div id="result_display" class="result-section" style="display: none;">
            <h3><i class="fas fa-clipboard-check"></i> Attendance Result</h3>
            <div id="result_content"></div>
        </div>
        
        <!-- Today's Attendance -->
        <div class="attendance-list">
            <h2><i class="fas fa-list-alt"></i> Today's Attendance Records</h2>
            
            <!-- Filter Section -->
            <div class="filter-section">
                <h3><i class="fas fa-filter"></i> Filter by Date Range</h3>
                <div class="filter-controls">
                    <div class="form-group">
                        <label for="start_date">Start Date:</label>
                        <input type="date" id="start_date" value="{{ today }}">
                    </div>
                    <div class="form-group">
                        <label for="end_date">End Date:</label>
                        <input type="date" id="end_date" value="{{ today }}">
                    </div>
                    <button onclick="filterAttendance()" class="btn-secondary"><i class="fas fa-search"></i> Filter</button>
                    <button onclick="resetFilter()" class="btn-outline"><i class="fas fa-redo"></i> Reset</button>
                </div>
            </div>
            
            <div id="attendance_table">
                {% if attendance %}
                    <table>
                        <thead>
                            <tr>
                                <th><i class="fas fa-hashtag"></i> #</th>
                                <th><i class="fas fa-user"></i> Name</th>
                                <th><i class="fas fa-calendar"></i> Date</th>
                                <th><i class="fas fa-clock"></i> Time</th>
                                <th><i class="fas fa-percent"></i> Confidence</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in attendance %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ record.user_name }}</td>
                                <td>{{ record.date }}</td>
                                <td>{{ record.time }}</td>
                                <td>{{ "%.2f"|format(record.confidence) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p style="text-align:center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-inbox" style="font-size: 3rem; display: block; margin-bottom: 15px; opacity: 0.3;"></i>
                        No attendance records for today.
                    </p>
                {% endif %}
            </div>
            
            <!-- Action Buttons -->
            <div class="export-buttons">
                <button onclick="refreshAttendance()" class="btn-secondary"><i class="fas fa-sync"></i> Refresh</button>
                <button onclick="exportToPDF()" class="btn-danger"><i class="fas fa-file-pdf"></i> Export as PDF</button>
                <button onclick="exportToExcel()" class="btn-success"><i class="fas fa-file-excel"></i> Export as Excel</button>
            </div>
        </div>
    </div>
    
    <script>
        let autoModeInterval = null;
        const AUTO_MODE_INTERVAL = 3000;
        // Timeout for system initialization (5 minutes = 300000ms)
        // Allows time for first-time model download + user data processing
        const INITIALIZATION_TIMEOUT_MS = 300000;
        let currentStartDate = '';
        let currentEndDate = '';
        let systemInitialized = false;
        
        document.addEventListener('DOMContentLoaded', () => {
            setTodayDate();
            initializeSystem();
            
            // Setup event listeners for registered users modal
            const registeredUsersCard = document.getElementById('registered_users_card');
            if (registeredUsersCard) {
                registeredUsersCard.addEventListener('click', showRegisteredUsers);
            }
            
            const closeBtn = document.getElementById('close_modal_btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeUsersModal);
            }
            
            // Close modal when clicking outside of it
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('users_modal');
                if (event.target === modal) {
                    closeUsersModal();
                }
            });
        });

        function initializeSystem() {
            // Start progress animation
            let progress = 0;
            const progressFill = document.getElementById('progress_fill');
            const loadingContent = document.querySelector('.loading-content');
            
            const progressInterval = setInterval(() => {
                progress += 2;
                if (progress <= 90) {
                    progressFill.style.width = progress + '%';
                }
            }, 300);
            
            // Update status messages during initialization
            const statusMessages = [
                'üîÑ Initializing Face Recognition System...',
                'üì¶ Loading InsightFace models...',
                'üß† Preparing face recognition engine...',
                'üë• Loading user database...',
                '‚öôÔ∏è Finalizing setup...'
            ];
            let messageIndex = 0;
            const messageInterval = setInterval(() => {
                if (messageIndex < statusMessages.length - 1) {
                    messageIndex++;
                    loadingContent.querySelector('h3').textContent = statusMessages[messageIndex];
                }
            }, 3000);
            
            // Create AbortController for timeout handling
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), INITIALIZATION_TIMEOUT_MS);
            
            // Initialize system in background
            fetch('/initialize_system', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                clearInterval(progressInterval);
                clearInterval(messageInterval);
                progressFill.style.width = '100%';
                
                if (data.success) {
                    // Update stats
                    document.getElementById('users_count').textContent = data.users_count;
                    document.getElementById('attendance_count').textContent = data.attendance_count;
                    
                    // Update attendance table
                    updateAttendanceTable(data.attendance);
                    
                    // Hide loading indicator
                    setTimeout(() => {
                        document.getElementById('loading_indicator').style.display = 'none';
                        systemInitialized = true;
                    }, 500);
                } else {
                    document.getElementById('loading_indicator').innerHTML = `
                        <div class="loading-content">
                            <h3 style="color: #EF4444;">‚ö†Ô∏è Initialization Failed</h3>
                            <p style="color: #DC2626;">${data.error || 'Unknown error occurred during initialization'}</p>
                            <button onclick="location.reload()" style="margin-top: 20px; padding: 12px 24px; background: white; color: #6366f1; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-redo"></i> Retry
                            </button>
                        </div>
                    `;
                }
            })
            .catch(error => {
                clearInterval(progressInterval);
                clearInterval(messageInterval);
                clearTimeout(timeoutId);
                
                let errorMessage = 'An unexpected error occurred';
                let troubleshooting = '';
                
                if (error.name === 'AbortError') {
                    errorMessage = 'Initialization timeout (exceeded 5 minutes)';
                    troubleshooting = `
                        <div style="margin-top: 15px; text-align: left; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                            <strong>Possible causes:</strong><br>
                            ‚Ä¢ Slow internet connection for model download<br>
                            ‚Ä¢ System resources exhausted (check CPU/memory)<br>
                            ‚Ä¢ Large database (67+ users should complete in 2-3 minutes)<br>
                            <br>
                            <strong>Suggestions:</strong><br>
                            ‚Ä¢ Ensure stable internet connection for model download<br>
                            ‚Ä¢ Check server logs for detailed error messages<br>
                            ‚Ä¢ Be patient on first load - subsequent loads will be instant<br>
                            ‚Ä¢ Try refreshing the page after a moment<br>
                        </div>
                    `;
                } else {
                    errorMessage = error.message || String(error);
                }
                
                document.getElementById('loading_indicator').innerHTML = `
                    <div class="loading-content">
                        <h3 style="color: #EF4444;">‚ö†Ô∏è Initialization Failed</h3>
                        <p style="color: #DC2626;">${errorMessage}</p>
                        ${troubleshooting}
                        <button onclick="location.reload()" style="margin-top: 20px; padding: 12px 24px; background: white; color: #6366f1; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                `;
            });
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start_date').value = today;
            document.getElementById('end_date').value = today;
        }

        // Auto mode functions
        function toggleAutoMode() {
            const enabled = document.getElementById('auto_mode_enabled').checked;
            const statusDiv = document.getElementById('auto_mode_status');
            const statusSpan = document.getElementById('auto_status');
            
            if (enabled) {
                statusDiv.style.display = 'block';
                statusSpan.textContent = 'Active ‚úÖ';
                statusSpan.style.color = '#10B981';
                statusSpan.style.fontWeight = 'bold';
                startAutoMode();
            } else {
                statusDiv.style.display = 'none';
                statusSpan.textContent = 'Inactive';
                stopAutoMode();
            }
        }
        
        function startAutoMode() {
            if (autoModeInterval) clearInterval(autoModeInterval);
            performAutoCapture();
            autoModeInterval = setInterval(performAutoCapture, AUTO_MODE_INTERVAL);
        }
        
        function stopAutoMode() {
            if (autoModeInterval) {
                clearInterval(autoModeInterval);
                autoModeInterval = null;
            }
        }
        
        function performAutoCapture() {
            const cameraSource = getCameraSource();
            
            if (!cameraSource || cameraSource.trim() === '') {
                stopAutoMode();
                document.getElementById('auto_mode_enabled').checked = false;
                document.getElementById('camera_result').innerHTML = '<p style="color: red;">Please specify a camera source</p>';
                return;
            }
            
            fetch('/mark_attendance_camera', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ camera_source: cameraSource, auto_mode: true })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) refreshAttendance();
                if (!data.success) displayResult(data);
            })
            .catch(error => {
                displayResult({ success: false, message: `Error: ${error}` });
                stopAutoMode();
                document.getElementById('auto_mode_enabled').checked = false;
            });
        }

        function toggleCameraInput() {
            const cameraType = document.querySelector('input[name="camera_type"]:checked').value;
            const cameraIndex = document.getElementById('camera_index');
            const cameraUrl = document.getElementById('camera_url');
            
            if (cameraType === 'local') {
                cameraIndex.disabled = false;
                cameraUrl.disabled = true;
            } else {
                cameraIndex.disabled = true;
                cameraUrl.disabled = false;
            }
        }
        
        function getCameraSource() {
            const cameraType = document.querySelector('input[name="camera_type"]:checked').value;
            return cameraType === 'local' 
                ? document.getElementById('camera_index').value 
                : document.getElementById('camera_url').value;
        }
        
        function testCamera() {
            const cameraSource = getCameraSource();
            
            if (!cameraSource || cameraSource.trim() === '') {
                document.getElementById('camera_result').innerHTML = '<p style="color: red;">Please specify a camera source</p>';
                return;
            }
            
            fetch(`/camera_test/${encodeURIComponent(cameraSource)}`)
                .then(response => response.json())
                .then(data => {
                    const resultDiv = document.getElementById('camera_result');
                    if (data.success) {
                        resultDiv.innerHTML = `
                            <div class="success">
                                <p><i class="fas fa-check-circle"></i> Camera working!</p>
                                <img src="data:image/jpeg;base64,${data.image}" style="max-width: 400px;">
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `<div class="error"><p><i class="fas fa-times-circle"></i> ${data.message}</p></div>`;
                    }
                })
                .catch(error => {
                    document.getElementById('camera_result').innerHTML = 
                        `<div class="error"><p><i class="fas fa-exclamation-triangle"></i> Error: ${error}</p></div>`;
                });
        }
        
        function markAttendanceCamera() {
            const cameraSource = getCameraSource();
            
            if (!cameraSource || cameraSource.trim() === '') {
                displayResult({ success: false, message: 'Please specify a camera source' });
                return;
            }
            
            fetch('/mark_attendance_camera', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ camera_source: cameraSource })
            })
            .then(response => response.json())
            .then(data => displayResult(data))
            .catch(error => displayResult({ success: false, message: `Error: ${error}` }));
        }
        
        function markAttendanceUpload() {
            const fileInput = document.getElementById('image_upload');
            const file = fileInput.files[0];
            
            if (!file) {
                displayResult({ success: false, message: 'Please select an image file' });
                return;
            }
            
            const formData = new FormData();
            formData.append('image', file);
            
            fetch('/mark_attendance_upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => displayResult(data))
            .catch(error => displayResult({ success: false, message: `Error: ${error}` }));
        }
        
        function displayResult(data) {
            const resultDiv = document.getElementById('result_display');
            const contentDiv = document.getElementById('result_content');
            
            if (data.success) {
                contentDiv.innerHTML = `
                    <div class="success fade-in">
                        <h4><i class="fas fa-check-circle"></i> ${data.message}</h4>
                        <p><strong>User:</strong> ${data.user_name}</p>
                        <p><strong>Confidence:</strong> ${data.confidence.toFixed(2)}</p>
                        <p><strong>Time:</strong> ${data.attendance_record.time}</p>
                        ${data.captured_image ? `<img src="data:image/jpeg;base64,${data.captured_image}" style="max-width: 300px;">` : ''}
                    </div>
                `;
                refreshAttendance();
            } else {
                contentDiv.innerHTML = `
                    <div class="error fade-in">
                        <h4><i class="fas fa-exclamation-triangle"></i> ${data.message}</h4>
                    </div>
                `;
            }
            
            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function refreshAttendance() {
            fetch('/get_attendance')
                .then(response => response.json())
                .then(data => updateAttendanceTable(data))
                .catch(error => console.error('Error refreshing attendance:', error));
        }
        
        function updateAttendanceTable(data) {
            const tableDiv = document.getElementById('attendance_table');
            if (data.length > 0) {
                let tableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th><i class="fas fa-hashtag"></i> #</th>
                                <th><i class="fas fa-user"></i> Name</th>
                                <th><i class="fas fa-calendar"></i> Date</th>
                                <th><i class="fas fa-clock"></i> Time</th>
                                <th><i class="fas fa-percent"></i> Confidence</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.forEach((record, index) => {
                    tableHTML += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${record.user_name}</td>
                            <td>${record.date}</td>
                            <td>${record.time}</td>
                            <td>${record.confidence.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                tableHTML += '</tbody></table>';
                tableDiv.innerHTML = tableHTML;
            } else {
                tableDiv.innerHTML = `
                    <p style="text-align:center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-inbox" style="font-size: 3rem; display: block; margin-bottom: 15px; opacity: 0.3;"></i>
                        No attendance records found.
                    </p>
                `;
            }
        }
        
        function filterAttendance() {
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            currentStartDate = startDate;
            currentEndDate = endDate;
            
            // For now, just refresh - the backend would need to support date range queries
            refreshAttendance();
        }
        
        function resetFilter() {
            setTodayDate();
            currentStartDate = '';
            currentEndDate = '';
            refreshAttendance();
        }
        
        function exportToPDF() {
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            
            let url = '/export_attendance_pdf';
            if (startDate && endDate) {
                url += `?start_date=${startDate}&end_date=${endDate}`;
            }
            
            window.location.href = url;
        }
        
        function exportToExcel() {
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            
            let url = '/export_attendance_excel';
            if (startDate && endDate) {
                url += `?start_date=${startDate}&end_date=${endDate}`;
            }
            
            window.location.href = url;
        }
        
        function showRegisteredUsers() {
            const modal = document.getElementById('users_modal');
            const usersList = document.getElementById('users_list');
            
            // Show modal
            modal.style.display = 'block';
            
            // Fetch users
            fetch('/get_users')
                .then(response => response.json())
                .then(users => {
                    if (users.length > 0) {
                        // Clear existing content
                        usersList.innerHTML = '';
                        
                        // Create users grid
                        const usersGrid = document.createElement('div');
                        usersGrid.className = 'users-grid';
                        
                        users.forEach((user, index) => {
                            // Create user card
                            const userCard = document.createElement('div');
                            userCard.className = 'user-card';
                            
                            // Create avatar
                            const avatar = document.createElement('div');
                            avatar.className = 'user-avatar';
                            const avatarIcon = document.createElement('i');
                            avatarIcon.className = 'fas fa-user';
                            avatar.appendChild(avatarIcon);
                            
                            // Create user info
                            const userInfo = document.createElement('div');
                            userInfo.className = 'user-info';
                            
                            const userName = document.createElement('h4');
                            userName.textContent = user; // Use textContent to prevent XSS
                            
                            const userNumber = document.createElement('p');
                            userNumber.textContent = `User #${index + 1}`;
                            
                            // Assemble the card
                            userInfo.appendChild(userName);
                            userInfo.appendChild(userNumber);
                            userCard.appendChild(avatar);
                            userCard.appendChild(userInfo);
                            usersGrid.appendChild(userCard);
                        });
                        
                        usersList.appendChild(usersGrid);
                    } else {
                        // Clear existing content
                        usersList.innerHTML = '';
                        
                        // Create "no users" message
                        const noUsersMsg = document.createElement('p');
                        noUsersMsg.style.textAlign = 'center';
                        noUsersMsg.style.padding = '40px';
                        noUsersMsg.style.color = '#6B7280';
                        
                        const noUsersIcon = document.createElement('i');
                        noUsersIcon.className = 'fas fa-user-slash';
                        noUsersIcon.style.fontSize = '3rem';
                        noUsersIcon.style.display = 'block';
                        noUsersIcon.style.marginBottom = '15px';
                        noUsersIcon.style.opacity = '0.3';
                        
                        noUsersMsg.appendChild(noUsersIcon);
                        noUsersMsg.appendChild(document.createTextNode('No registered users yet.'));
                        
                        usersList.appendChild(noUsersMsg);
                    }
                })
                .catch(error => {
                    // Clear existing content
                    usersList.innerHTML = '';
                    
                    // Create error message using textContent to prevent XSS
                    const errorContainer = document.createElement('p');
                    errorContainer.style.textAlign = 'center';
                    errorContainer.style.color = '#EF4444';
                    
                    const errorIcon = document.createElement('i');
                    errorIcon.className = 'fas fa-exclamation-triangle';
                    
                    errorContainer.appendChild(errorIcon);
                    errorContainer.appendChild(document.createTextNode(' Error loading users'));
                    
                    usersList.appendChild(errorContainer);
                });
        }
        
        function closeUsersModal() {
            document.getElementById('users_modal').style.display = 'none';
        }
    
    </script>
</body>
</html>
