<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNN Training - Attendance System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .training-section {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-good { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .model-switch {
            background: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .training-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
        }
        .file-drop-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 15px 0;
            transition: border-color 0.3s ease;
        }
        .file-drop-zone.dragover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        .training-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        @media (max-width: 768px) {
            .training-controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CNN Training System</h1>
        
        <!-- Navigation -->
        <nav>
            <a href="{{ url_for('index') }}">Home</a>
            <a href="{{ url_for('add_user') }}">Add User</a>
            <a href="{{ url_for('cnn_training') }}" class="active">CNN Training</a>
        </nav>
        
        <!-- Current Status -->
        <div class="training-section">
            <h2>Current Status</h2>
            <div id="statusInfo">
                <p><span class="status-indicator status-warning"></span>Loading status...</p>
            </div>
            
            <!-- Model Selection -->
            <div class="model-switch">
                <h3>Recognition Model</h3>
                <div>
                    <label>
                        <input type="radio" name="model_type" value="insightface" onchange="switchModel(this.value)">
                        InsightFace (Default)
                    </label>
                </div>
                <div>
                    <label>
                        <input type="radio" name="model_type" value="cnn" onchange="switchModel(this.value)">
                        Custom CNN Model
                    </label>
                </div>
                <small>Switch between the general-purpose InsightFace model and your custom-trained CNN model.</small>
            </div>
            
            <!-- Auto-training Toggle -->
            <div style="margin: 15px 0;">
                <label>
                    <input type="checkbox" id="autoTraining" onchange="toggleAutoTraining(this.checked)">
                    Enable Auto-Training (automatically retrain when unknown faces are detected)
                </label>
            </div>
        </div>
        
        <!-- Training Data Management -->
        <div class="training-section">
            <h2>Training Data Management</h2>
            
            <!-- Manual Training -->
            <div class="training-controls">
                <div>
                    <h3>Manual Training</h3>
                    <p>Train the CNN model with current database images:</p>
                    <button onclick="startTraining()" class="btn btn-primary" id="trainBtn">
                        Start Training
                    </button>
                    <br><br>
                    <label for="epochs">Training Epochs:</label>
                    <input type="number" id="epochs" value="50" min="10" max="200" style="width: 80px;">
                </div>
                
                <div>
                    <h3>Quick Actions</h3>
                    <button onclick="prepareData()" class="btn btn-secondary">
                        Prepare Training Data
                    </button>
                    <br><br>
                    <button onclick="loadStatus()" class="btn btn-secondary">
                        Refresh Status
                    </button>
                </div>
            </div>
            
            <!-- Training Progress -->
            <div id="trainingProgress" style="display: none;">
                <h3>Training Progress</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                </div>
                <p id="progressText">Preparing training...</p>
            </div>
        </div>
        
        <!-- Add Training Data -->
        <div class="training-section">
            <h2>Add Training Data</h2>
            
            <!-- Image Upload -->
            <div>
                <h3>Upload Images</h3>
                <form id="uploadForm" enctype="multipart/form-data">
                    <div>
                        <label for="userName">User Name:</label>
                        <input type="text" id="userName" name="user_name" required 
                               placeholder="Enter user name for training">
                    </div>
                    <br>
                    <div class="file-drop-zone" id="dropZone">
                        <p>Drag and drop images here or click to select</p>
                        <input type="file" id="imageFiles" name="images" multiple accept="image/*" style="display: none;">
                        <button type="button" onclick="document.getElementById('imageFiles').click()" class="btn btn-secondary">
                            Select Images
                        </button>
                    </div>
                    <div id="selectedFiles"></div>
                    <br>
                    <button type="submit" class="btn btn-primary">Add Training Images</button>
                </form>
            </div>
            
            <hr>
            
            <!-- Video Upload -->
            <div>
                <h3>Extract from Video</h3>
                <form id="videoForm" enctype="multipart/form-data">
                    <div>
                        <label for="videoUserName">User Name:</label>
                        <input type="text" id="videoUserName" name="user_name" required>
                    </div>
                    <br>
                    <div>
                        <label for="videoFile">Video File:</label>
                        <input type="file" id="videoFile" name="video" accept="video/*" required>
                    </div>
                    <br>
                    <div>
                        <label for="frameInterval">Extract every N frames:</label>
                        <input type="number" id="frameInterval" name="frame_interval" value="30" min="1" max="100">
                        <small>(Lower values = more images, higher processing time)</small>
                    </div>
                    <br>
                    <button type="submit" class="btn btn-primary">Extract Training Data</button>
                </form>
            </div>
        </div>
        
        <!-- Training Log -->
        <div class="training-section">
            <h2>Training Log</h2>
            <div class="training-log" id="trainingLog">
                <p>Training log will appear here...</p>
            </div>
            <button onclick="clearLog()" class="btn btn-secondary">Clear Log</button>
        </div>
    </div>

    <script>
        let trainingInProgress = false;
        let logMessages = [];

        // Load initial status
        document.addEventListener('DOMContentLoaded', function() {
            loadStatus();
            setupFileUpload();
        });

        function loadStatus() {
            fetch('/cnn_status')
                .then(response => response.json())
                .then(data => {
                    updateStatusDisplay(data);
                })
                .catch(error => {
                    console.error('Error loading status:', error);
                    addLogMessage('Error loading status: ' + error.message, 'error');
                });
        }

        function updateStatusDisplay(status) {
            const statusDiv = document.getElementById('statusInfo');
            let html = '';
            
            // Current model
            const modelType = status.current_model || 'InsightFace';
            const statusClass = status.cnn_model_available ? 'status-good' : 'status-warning';
            html += `<p><span class="status-indicator ${statusClass}"></span>Current Model: ${modelType}</p>`;
            
            // CNN model availability
            if (status.cnn_model_available) {
                html += `<p><span class="status-indicator status-good"></span>CNN Model: Available (${status.cnn_training_status?.num_classes || 0} classes)</p>`;
            } else {
                html += `<p><span class="status-indicator status-warning"></span>CNN Model: Not trained yet</p>`;
            }
            
            // Auto-training status
            const autoStatus = status.auto_training_enabled ? 'status-good' : 'status-warning';
            html += `<p><span class="status-indicator ${autoStatus}"></span>Auto-Training: ${status.auto_training_enabled ? 'Enabled' : 'Disabled'}</p>`;
            
            // Training data
            if (status.cnn_training_status) {
                html += `<p><span class="status-indicator status-good"></span>Training Data: ${status.cnn_training_status.training_data_count} samples</p>`;
                
                if (status.cnn_training_status.last_training) {
                    const lastTraining = status.cnn_training_status.last_training;
                    html += `<p><span class="status-indicator status-good"></span>Last Training: ${new Date(lastTraining.timestamp).toLocaleString()}</p>`;
                    html += `<p style="margin-left: 20px;">Accuracy: ${(lastTraining.final_val_accuracy * 100).toFixed(1)}% | Classes: ${lastTraining.num_classes} | Samples: ${lastTraining.num_samples}</p>`;
                }
            }
            
            statusDiv.innerHTML = html;
            
            // Update model selection
            const modelRadio = document.querySelector(`input[name="model_type"][value="${modelType.toLowerCase()}"]`);
            if (modelRadio) {
                modelRadio.checked = true;
            }
            
            // Update auto-training checkbox
            document.getElementById('autoTraining').checked = status.auto_training_enabled || false;
        }

        function switchModel(modelType) {
            fetch('/cnn_switch_model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ model_type: modelType })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLogMessage(`Switched to ${modelType} model`, 'info');
                    loadStatus();
                } else {
                    addLogMessage(`Failed to switch model: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                addLogMessage('Error switching model: ' + error.message, 'error');
            });
        }

        function toggleAutoTraining(enabled) {
            fetch('/cnn_toggle_auto_training', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ enabled: enabled })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLogMessage(`Auto-training ${enabled ? 'enabled' : 'disabled'}`, 'info');
                } else {
                    addLogMessage(`Failed to toggle auto-training: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                addLogMessage('Error toggling auto-training: ' + error.message, 'error');
            });
        }

        function prepareData() {
            addLogMessage('Preparing training data...', 'info');
            
            fetch('/cnn_prepare_data', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLogMessage(`Data preparation completed: ${data.samples_prepared} samples from ${data.users_count} users`, 'success');
                    loadStatus();
                } else {
                    addLogMessage(`Data preparation failed: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                addLogMessage('Error preparing data: ' + error.message, 'error');
            });
        }

        function startTraining() {
            if (trainingInProgress) {
                addLogMessage('Training already in progress', 'warning');
                return;
            }
            
            const epochs = parseInt(document.getElementById('epochs').value);
            trainingInProgress = true;
            
            document.getElementById('trainBtn').disabled = true;
            document.getElementById('trainBtn').textContent = 'Training...';
            document.getElementById('trainingProgress').style.display = 'block';
            
            addLogMessage(`Starting CNN training with ${epochs} epochs...`, 'info');
            
            fetch('/cnn_train', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ epochs: epochs })
            })
            .then(response => response.json())
            .then(data => {
                trainingInProgress = false;
                document.getElementById('trainBtn').disabled = false;
                document.getElementById('trainBtn').textContent = 'Start Training';
                document.getElementById('trainingProgress').style.display = 'none';
                
                if (data.success) {
                    addLogMessage('Training completed successfully!', 'success');
                    if (data.training_log) {
                        const log = data.training_log;
                        addLogMessage(`Final accuracy: ${(log.final_val_accuracy * 100).toFixed(1)}%`, 'success');
                        addLogMessage(`Training time: ${log.training_time_seconds.toFixed(1)} seconds`, 'info');
                        addLogMessage(`Classes trained: ${log.num_classes}`, 'info');
                    }
                    loadStatus();
                } else {
                    addLogMessage(`Training failed: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                trainingInProgress = false;
                document.getElementById('trainBtn').disabled = false;
                document.getElementById('trainBtn').textContent = 'Start Training';
                document.getElementById('trainingProgress').style.display = 'none';
                addLogMessage('Training error: ' + error.message, 'error');
            });
        }

        function setupFileUpload() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('imageFiles');
            const selectedFilesDiv = document.getElementById('selectedFiles');
            
            // File selection display
            fileInput.addEventListener('change', function() {
                displaySelectedFiles(this.files);
            });
            
            // Drag and drop functionality
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                fileInput.files = e.dataTransfer.files;
                displaySelectedFiles(e.dataTransfer.files);
            });
            
            function displaySelectedFiles(files) {
                let html = '<p>Selected files:</p><ul>';
                for (let file of files) {
                    html += `<li>${file.name}</li>`;
                }
                html += '</ul>';
                selectedFilesDiv.innerHTML = html;
            }
            
            // Upload form submission
            document.getElementById('uploadForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData();
                formData.append('user_name', document.getElementById('userName').value);
                
                const files = document.getElementById('imageFiles').files;
                for (let file of files) {
                    formData.append('images', file);
                }
                
                addLogMessage(`Uploading ${files.length} images...`, 'info');
                
                fetch('/cnn_add_training_images', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addLogMessage(`Images uploaded successfully: ${data.images_processed} processed`, 'success');
                        document.getElementById('uploadForm').reset();
                        selectedFilesDiv.innerHTML = '';
                        loadStatus();
                    } else {
                        addLogMessage(`Upload failed: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    addLogMessage('Upload error: ' + error.message, 'error');
                });
            });
            
            // Video form submission
            document.getElementById('videoForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData();
                formData.append('user_name', document.getElementById('videoUserName').value);
                formData.append('video', document.getElementById('videoFile').files[0]);
                formData.append('frame_interval', document.getElementById('frameInterval').value);
                
                addLogMessage('Processing video for training data...', 'info');
                
                fetch('/cnn_add_training_video', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addLogMessage(`Video processed: ${data.faces_extracted} faces extracted from ${data.frames_processed} frames`, 'success');
                        document.getElementById('videoForm').reset();
                        loadStatus();
                    } else {
                        addLogMessage(`Video processing failed: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    addLogMessage('Video processing error: ' + error.message, 'error');
                });
            });
        }

        function addLogMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = {
                'info': 'ℹ️',
                'success': '✅',
                'warning': '⚠️',
                'error': '❌'
            };
            
            const logMessage = `[${timestamp}] ${typeIcon[type] || 'ℹ️'} ${message}`;
            logMessages.push(logMessage);
            
            // Keep only last 100 messages
            if (logMessages.length > 100) {
                logMessages = logMessages.slice(-100);
            }
            
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logDiv = document.getElementById('trainingLog');
            logDiv.innerHTML = logMessages.join('\n');
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            logMessages = [];
            updateLogDisplay();
        }

        // Refresh status every 30 seconds
        setInterval(loadStatus, 30000);
    </script>
</body>
</html>
